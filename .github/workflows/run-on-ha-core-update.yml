name: Sync evohome from HA Core

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *" # Daily at 03:17 UTC (adjust as you prefer)

permissions:
  contents: write

concurrency:
  group: sync-evohome-from-ha-core
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout THIS repo (yours), full history for reliable diffs/commits
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2) Checkout ONLY the evohome directory from HA Core with sparse checkout
      - name: Checkout home-assistant/core (sparse)
        uses: actions/checkout@v4
        with:
          repository: home-assistant/core
          path: _ha_core
          fetch-depth: 1
          # Do NOT set ref; default branch of HA Core will be used automatically.
          # If you need a specific branch, add: ref: dev (or main/master)
          sparse-checkout: |
            homeassistant/components/evohome
          sparse-checkout-cone-mode: true

      # 3) Sync files into your repo under ha_evohome_original/evohome/
      #    Using rsync with --delete so removed upstream files are removed here too.
      - name: Sync evohome folder into this repo
        run: |
          set -euxo pipefail
          # Based on the description here:
          #  https://github.com/zxdavb/evohome-async/wiki/Hass:-Multiple-Evohome-Locations      
          # This script is tested on Home Assistant OS.
          # The script should be placed in this location: /config/custom_components/ and run from there.
          # Run the script once every time you have updated the HA core.
          #
          # How many extra copies of the integration do you want?
          INSTANCES=1      
          #
          # List current folder contents & goto custom components folder         
          ls -al
          mkdir -p ./custom_components
          ls -al ./custom_components          
                      
          # Delete all old evohome folders
          echo "Removing all evohome_x folders..."
          rm -rf custom_components/evohome_cc*
                    
          # Create all new evohome instances
          for i in $(seq $INSTANCES)
          do
            echo "Creating evohome_cc$i/" 
           
            # Copy the evohome folder
            mkdir -p custom_components/evohome_cc$i
            rsync -a --delete "_ha_core/homeassistant/components/evohome/" "custom_components/evohome_cc$i"
          
            echo "Updating files in evohome_cc$i/"
            cd custom_components/evohome_cc$i/
            # Update the files within the integration with proper values
            sed -i "/domain/ s/evohome/evohome_cc$i/" manifest.json
            sed -i 's/"name": *"[^"]*"/"name": "evohome_cc$i (custom_component)"/' manifest.json
            sed -i 's#"documentation": *"[^"]*"#"documentation": "https://github.com/madcowGit/evohome_cc1"#' manifest.json
            
            sed -i '/"codeowners":/{
              s/\]/, "@madcowGit"\]/
              s/, "@madcowGit", "@madcowGit"/, "@madcowGit"/
            }' manifest.json
            
            sed -i '/{/a \ \ "version": "0.0.1",'     manifest.json
            sed -i "/DOMAIN/ s/evohome/evohome_cc$i/" const.py
          done

      # 4) Determine if anything actually changed
      - name: Check for changes
        id: changes
        run: |
          set -e
          if [ -n "$(git status --porcelain -- custom_components)" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # 5) Commit & push only if changed
      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          set -euxo pipefail

          # Identify upstream HA Core commit for traceability
          HA_SHA=$(git -C _ha_core rev-parse --short HEAD || echo "unknown")
          HA_BRANCH=$(git -C _ha_core rev-parse --abbrev-ref HEAD || echo "unknown")

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add custom_components
          git commit -m "chore(sync): evohome from home-assistant/core@${HA_SHA} (${HA_BRANCH}) [skip ci]"
          git push